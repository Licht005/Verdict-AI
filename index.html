<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Verdict AI ‚Äî Ghana Constitutional Law</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Serif:ital,wght@0,400;0,600;1,400&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg:           #0e0f11;
    --surface:      #16181c;
    --surface-2:    #1e2026;
    --surface-3:    #252830;
    --border:       #2a2d35;
    --border-light: #22252d;
    --text:         #e2e4e9;
    --text-2:       #8b8f9a;
    --text-3:       #4e5260;
    --accent:       #4a7fa5;
    --accent-dim:   #2d5070;
    --gold:         #c9a84c;
    --gold-dim:     #7a6030;
    --red:          #c0392b;
    --green:        #27ae60;
    --shadow:       0 1px 4px rgba(0,0,0,0.4), 0 4px 20px rgba(0,0,0,0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
  .topbar {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 32px;
    height: 54px;
    flex-shrink: 0;
  }

  .topbar-brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .topbar-seal {
    width: 28px;
    height: 28px;
    border: 1px solid var(--accent-dim);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    color: var(--accent);
  }

  .topbar-name {
    font-family: 'IBM Plex Serif', serif;
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
  }

  .topbar-name span {
    font-weight: 400;
    font-style: italic;
    color: var(--accent);
    margin-left: 2px;
  }

  .topbar-meta {
    font-size: 11px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-3);
    font-family: 'IBM Plex Mono', monospace;
  }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  .layout {
    display: flex;
    flex: 1;
    max-width: 1100px;
    width: 100%;
    margin: 0 auto;
    padding: 28px 24px;
    gap: 20px;
  }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  .sidebar {
    width: 210px;
    flex-shrink: 0;
  }

  .sidebar-section { margin-bottom: 24px; }

  .sidebar-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--text-3);
    font-family: 'IBM Plex Mono', monospace;
    margin-bottom: 8px;
  }

  .mode-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 9px 11px;
    border: 1px solid transparent;
    border-radius: 5px;
    background: transparent;
    color: var(--text-2);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    text-align: left;
    margin-bottom: 2px;
  }

  .mode-btn:hover { background: var(--surface-2); color: var(--text); }

  .mode-btn.active {
    background: var(--surface-2);
    border-color: var(--border);
    color: var(--text);
  }

  .btn-icon {
    width: 26px;
    height: 26px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    background: var(--surface-3);
    flex-shrink: 0;
  }

  .mode-btn.active .btn-icon {
    background: var(--accent-dim);
    color: var(--accent);
  }

  .sidebar-divider {
    height: 1px;
    background: var(--border);
    margin: 18px 0;
  }

  .sidebar-info {
    font-size: 11px;
    color: var(--text-3);
    line-height: 1.8;
    font-family: 'IBM Plex Mono', monospace;
  }

  .status-dot {
    display: inline-block;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--green);
    margin-right: 6px;
    vertical-align: middle;
  }

  /* ‚îÄ‚îÄ Main panel ‚îÄ‚îÄ */
  .panel {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 600px;
  }

  .panel-header {
    padding: 18px 22px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    background: var(--surface-2);
  }

  .panel-title {
    font-family: 'IBM Plex Serif', serif;
    font-size: 22px;
    font-weight: 600;
    color: var(--text);
    line-height: 1.3;
  }

  .panel-title span {
    display: block;
    font-size: 13px;
    font-family: 'IBM Plex Mono', monospace;
    font-weight: 400;
    color: var(--text-3);
    margin-top: 3px;
    letter-spacing: 0.05em;
  }

  .panel-badge {
    font-size: 12px;
    font-family: 'IBM Plex Mono', monospace;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--gold);
    background: rgba(201,168,76,0.08);
    border: 1px solid var(--gold-dim);
    padding: 5px 12px;
    border-radius: 3px;
    white-space: nowrap;
  }

  /* ‚îÄ‚îÄ Messages ‚îÄ‚îÄ */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px 22px;
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .messages::-webkit-scrollbar { width: 3px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .message {
    display: flex;
    gap: 13px;
    padding: 14px 0;
    border-bottom: 1px solid var(--border-light);
    animation: fadeIn 0.2s ease;
  }

  .message:last-child { border-bottom: none; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .msg-avatar {
    width: 34px;
    height: 34px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    flex-shrink: 0;
    margin-top: 2px;
    font-family: 'IBM Plex Mono', monospace;
    letter-spacing: 0.05em;
  }

  .message.user .msg-avatar {
    background: var(--accent-dim);
    color: var(--accent);
    border: 1px solid rgba(74,127,165,0.2);
  }

  .message.assistant .msg-avatar {
    background: var(--surface-3);
    color: var(--gold);
    border: 1px solid var(--border);
  }

  .msg-body { flex: 1; min-width: 0; }

  .msg-label {
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-3);
    font-family: 'IBM Plex Mono', monospace;
    margin-bottom: 5px;
  }

  .message.user .msg-label { color: var(--accent); opacity: 0.7; }
  .message.assistant .msg-label { color: var(--gold); opacity: 0.7; }

  .msg-text {
    font-size: 16px;
    line-height: 1.8;
    color: var(--text);
    font-weight: 300;
  }

  .message.assistant .msg-text {
    font-family: 'IBM Plex Serif', serif;
    font-size: 16px;
    color: #d0d4dc;
  }

  /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 48px 32px;
    text-align: center;
  }

  .empty-icon {
    font-size: 32px;
    margin-bottom: 16px;
    opacity: 0.25;
  }

  .empty-title {
    font-family: 'IBM Plex Serif', serif;
    font-size: 20px;
    color: var(--text-2);
    margin-bottom: 8px;
    font-weight: 400;
  }

  .empty-sub {
    font-size: 14px;
    line-height: 1.7;
    color: var(--text-3);
    max-width: 300px;
    font-family: 'IBM Plex Mono', monospace;
  }

  .chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 20px;
    justify-content: center;
  }

  .chip {
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: 3px;
    font-size: 13px;
    color: var(--text-3);
    cursor: pointer;
    transition: all 0.15s;
    background: var(--surface-2);
    font-family: 'IBM Plex Mono', monospace;
  }

  .chip:hover {
    border-color: var(--accent-dim);
    color: var(--accent);
    background: rgba(74,127,165,0.07);
  }

  /* ‚îÄ‚îÄ Input ‚îÄ‚îÄ */
  .input-area {
    border-top: 1px solid var(--border);
    padding: 14px 22px;
    background: var(--surface-2);
  }

  .text-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }

  textarea {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 15px;
    font-weight: 300;
    padding: 11px 14px;
    resize: none;
    min-height: 46px;
    max-height: 160px;
    outline: none;
    transition: border-color 0.15s;
    line-height: 1.6;
  }

  textarea:focus { border-color: var(--accent-dim); }
  textarea::placeholder { color: var(--text-3); }

  .send-btn {
    height: 46px;
    padding: 0 18px;
    background: var(--accent-dim);
    color: var(--accent);
    border: 1px solid rgba(74,127,165,0.25);
    border-radius: 4px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    letter-spacing: 0.05em;
  }

  .send-btn:hover {
    background: rgba(74,127,165,0.25);
    color: #7ab8e0;
    border-color: var(--accent);
  }

  .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  .clear-btn {
    height: 46px;
    padding: 0 14px;
    background: transparent;
    color: var(--text-3);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    letter-spacing: 0.05em;
  }

  .clear-btn:hover {
    color: var(--red);
    border-color: rgba(192,57,43,0.4);
    background: rgba(192,57,43,0.06);
  }

  .stop-btn {
    height: 46px;
    padding: 0 16px;
    background: rgba(192,57,43,0.1);
    color: #e07060;
    border: 1px solid rgba(192,57,43,0.3);
    border-radius: 4px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    letter-spacing: 0.05em;
    display: none;
  }

  .stop-btn.visible { display: block; }

  .stop-btn:hover {
    background: rgba(192,57,43,0.2);
    color: #ff8070;
  }

  /* ‚îÄ‚îÄ Voice panel ‚îÄ‚îÄ */
  .voice-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .voice-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px 22px;
  }

  .voice-messages::-webkit-scrollbar { width: 3px; }
  .voice-messages::-webkit-scrollbar-thumb { background: var(--border); }

  .voice-controls {
    border-top: 1px solid var(--border);
    padding: 28px 22px;
    background: var(--surface-2);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }

  .waveform {
    display: flex;
    align-items: center;
    gap: 3px;
    height: 24px;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .waveform.active { opacity: 1; }

  .bar {
    width: 2px;
    background: var(--red);
    border-radius: 1px;
    animation: wavebar 0.9s ease-in-out infinite;
  }

  .bar:nth-child(1) { animation-delay: 0.0s; }
  .bar:nth-child(2) { animation-delay: 0.1s; }
  .bar:nth-child(3) { animation-delay: 0.2s; }
  .bar:nth-child(4) { animation-delay: 0.3s; }
  .bar:nth-child(5) { animation-delay: 0.4s; }
  .bar:nth-child(6) { animation-delay: 0.3s; }
  .bar:nth-child(7) { animation-delay: 0.2s; }
  .bar:nth-child(8) { animation-delay: 0.1s; }
  .bar:nth-child(9) { animation-delay: 0.0s; }

  @keyframes wavebar {
    0%, 100% { height: 3px; }
    50%       { height: 18px; }
  }

  .voice-row {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .voice-btn {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 1px solid var(--border);
    background: var(--surface-3);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    transition: all 0.2s;
    box-shadow: var(--shadow);
    flex-shrink: 0;
  }

  .voice-btn:hover {
    border-color: var(--accent-dim);
    background: rgba(74,127,165,0.1);
  }

  .voice-btn.recording {
    border-color: var(--red);
    background: rgba(192,57,43,0.1);
    animation: recordPulse 2s infinite;
  }

  .voice-btn.processing {
    border-color: var(--gold-dim);
    background: rgba(201,168,76,0.07);
  }

  .voice-btn.playing {
    border-color: var(--green);
    background: rgba(39,174,96,0.07);
  }

  @keyframes recordPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(192,57,43,0.2), var(--shadow); }
    50%       { box-shadow: 0 0 0 10px rgba(192,57,43,0), var(--shadow); }
  }

  .voice-info { text-align: left; }

  .voice-status {
    font-size: 15px;
    font-weight: 500;
    color: var(--text);
    margin-bottom: 3px;
  }

  .voice-hint {
    font-size: 13px;
    color: var(--text-3);
    font-family: 'IBM Plex Mono', monospace;
  }

  /* ‚îÄ‚îÄ Thinking ‚îÄ‚îÄ */
  .thinking {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 14px 0;
    color: var(--text-3);
    font-size: 13px;
    font-family: 'IBM Plex Mono', monospace;
    letter-spacing: 0.06em;
    border-bottom: 1px solid var(--border-light);
  }

  .dot {
    width: 3px; height: 3px;
    background: var(--gold-dim);
    border-radius: 50%;
    animation: blink 1.2s infinite;
  }
  .dot:nth-child(2) { animation-delay: 0.2s; }
  .dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes blink {
    0%, 100% { opacity: 0.2; }
    50%       { opacity: 1; }
  }

  /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
  .error-msg {
    padding: 10px 14px;
    background: rgba(192,57,43,0.08);
    border: 1px solid rgba(192,57,43,0.25);
    border-radius: 4px;
    font-size: 13px;
    color: #e07060;
    margin-top: 8px;
    font-family: 'IBM Plex Mono', monospace;
  }

  .hidden { display: none !important; }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-brand">
    <div class="topbar-seal">‚öñ</div>
    <div class="topbar-name">Verdict<span>AI</span></div>
  </div>
  <div class="topbar-meta">Ghana Constitutional Law ¬∑ Research Assistant</div>
</div>

<div class="layout">

  <div class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Interface</div>
      <button class="mode-btn active" id="textModeBtn" onclick="setMode('text')">
        <div class="btn-icon">‚å®</div> Text Query
      </button>
      <button class="mode-btn" id="voiceModeBtn" onclick="setMode('voice')">
        <div class="btn-icon">üéô</div> Voice Query
      </button>
    </div>

    <div class="sidebar-divider"></div>

    <div class="sidebar-section">
      <div class="sidebar-label">System</div>
      <div class="sidebar-info">
        <div><span class="status-dot"></span>RAG Online</div>
        <div>Model: LLaMA 3.3 70B</div>
        <div>STT: Whisper v3</div>
        <div>TTS: ElevenLabs</div>
        <div>Source: GH Constitution</div>
      </div>
    </div>

    <div class="sidebar-divider"></div>

    <div class="sidebar-section">
      <div class="sidebar-label">Built by</div>
      <div class="sidebar-info">Lucas ¬∑ 2025</div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">
        Constitutional Query
        <span id="modeLabel">Text mode ¬∑ Ask any question</span>
      </div>
      <div class="panel-badge">1992 Constitution</div>
    </div>

    <!-- TEXT MODE -->
    <div id="textMode">
      <div class="messages" id="messages">
        <div class="empty-state" id="emptyState">
          <div class="empty-icon">üìú</div>
          <div class="empty-title">Ask about Ghana's Constitution</div>
          <div class="empty-sub">Query any article, right, chapter or provision. Verdict AI cites the exact clause.</div>
          <div class="chips">
            <div class="chip" onclick="fill('What does Article 6 say?')">Article 6</div>
            <div class="chip" onclick="fill('What are the fundamental human rights?')">Human Rights</div>
            <div class="chip" onclick="fill('What does Article 35 say?')">Article 35</div>
            <div class="chip" onclick="fill('What is the role of Parliament?')">Parliament</div>
            <div class="chip" onclick="fill('What does the Constitution say about freedom of speech?')">Free Speech</div>
          </div>
        </div>
      </div>

      <div class="input-area">
        <div class="text-row">
          <textarea id="questionInput"
            placeholder="Ask about any article, right, or constitutional provision‚Ä¶"
            rows="1"
            onkeydown="handleKey(event)"
            oninput="autoResize(this)"></textarea>
          <button class="clear-btn" onclick="clearChat()" title="Clear conversation">Clear</button>
          <button class="send-btn" id="sendBtn" onclick="sendText()">Submit ‚Üí</button>
        </div>
        <div id="textError"></div>
      </div>
    </div>

    <!-- VOICE MODE -->
    <div id="voiceMode" class="hidden">
      <div class="voice-body">
        <div class="voice-messages" id="voiceMessages"></div>

        <div class="input-area">
          <div class="waveform" id="waveform">
            <div class="bar"></div><div class="bar"></div><div class="bar"></div>
            <div class="bar"></div><div class="bar"></div><div class="bar"></div>
            <div class="bar"></div><div class="bar"></div><div class="bar"></div>
          </div>
          <div class="voice-row">
            <div class="voice-btn" id="voiceBtn" onclick="toggleRecording()">
              <span id="orbIcon">üéô</span>
            </div>
            <div class="voice-info">
              <div class="voice-status" id="voiceStatus">Press to speak</div>
              <div class="voice-hint" id="voiceHint">Tap to begin recording</div>
            </div>
            <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
              <button class="stop-btn" id="stopAudioBtn" onclick="stopAudio()">‚èπ Stop</button>
              <button class="clear-btn" onclick="clearVoiceChat()" title="Clear voice history">Clear</button>
            </div>
          </div>
          <div id="voiceError"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
const API = 'http://localhost:8000';
let mode = 'text';
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let currentAudio = null;

function setMode(m) {
  mode = m;
  document.getElementById('textMode').classList.toggle('hidden', m !== 'text');
  document.getElementById('voiceMode').classList.toggle('hidden', m !== 'voice');
  document.getElementById('textModeBtn').classList.toggle('active', m === 'text');
  document.getElementById('voiceModeBtn').classList.toggle('active', m === 'voice');
  document.getElementById('modeLabel').textContent =
    m === 'text' ? 'Text mode ¬∑ Ask any question' : 'Voice mode ¬∑ Speak your question';
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendText(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 160) + 'px';
}

function fill(q) {
  const input = document.getElementById('questionInput');
  input.value = q;
  input.focus();
  autoResize(input);
}

async function sendText() {
  const input = document.getElementById('questionInput');
  const question = input.value.trim();
  if (!question) return;

  input.value = '';
  input.style.height = 'auto';
  document.getElementById('sendBtn').disabled = true;
  document.getElementById('textError').innerHTML = '';
  hideEmpty();
  addMsg('messages', 'user', question);
  const thinking = addThinking('messages');

  try {
    const res = await fetch(`${API}/ask`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question })
    });
    if (!res.ok) throw new Error(`Server returned ${res.status}`);
    const data = await res.json();
    thinking.remove();
    addMsg('messages', 'assistant', data.answer);
  } catch (e) {
    thinking.remove();
    document.getElementById('textError').innerHTML =
      `<div class="error-msg">‚ö† ${e.message} ‚Äî is the server running? (python api.py)</div>`;
  }
  document.getElementById('sendBtn').disabled = false;
}

async function toggleRecording() {
  if (isRecording) stopRecording();
  else await startRecording();
}

async function startRecording() {
  if (currentAudio) { currentAudio.pause(); currentAudio = null; }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioChunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = processVoice;
    mediaRecorder.start();
    isRecording = true;
    setOrb('recording');
  } catch {
    document.getElementById('voiceError').innerHTML =
      `<div class="error-msg">‚ö† Microphone access denied.</div>`;
  }
}

function stopRecording() {
  if (mediaRecorder && isRecording) {
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(t => t.stop());
    isRecording = false;
    setOrb('processing');
  }
}

async function processVoice() {
  const blob = new Blob(audioChunks, { type: 'audio/webm' });
  const fd = new FormData();
  fd.append('audio', blob, 'recording.webm');
  document.getElementById('voiceError').innerHTML = '';

  try {
    const res = await fetch(`${API}/ask-voice`, { method: 'POST', body: fd });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.detail || `Server returned ${res.status}`);
    }

    const qRaw = res.headers.get('X-Question') || '';
    const aRaw = res.headers.get('X-Answer') || '';
    const question = qRaw ? atob(qRaw) : '(voice question)';
    const answer   = aRaw ? atob(aRaw) : '';

    addMsg('voiceMessages', 'user', question);
    addMsg('voiceMessages', 'assistant', answer + (answer.length >= 800 ? '‚Ä¶' : ''));

    const audioBlob = await res.blob();
    const url = URL.createObjectURL(audioBlob);
    currentAudio = new Audio(url);
    setOrb('playing');
    document.getElementById('stopAudioBtn').classList.add('visible');
    currentAudio.play();
    currentAudio.onended = () => {
      setOrb('idle');
      document.getElementById('stopAudioBtn').classList.remove('visible');
      URL.revokeObjectURL(url);
    };
  } catch (e) {
    setOrb('idle');
    document.getElementById('voiceError').innerHTML =
      `<div class="error-msg">‚ö† ${e.message}</div>`;
  }
}

function setOrb(state) {
  const btn    = document.getElementById('voiceBtn');
  const status = document.getElementById('voiceStatus');
  const hint   = document.getElementById('voiceHint');
  const wave   = document.getElementById('waveform');
  const icon   = document.getElementById('orbIcon');

  btn.className = 'voice-btn';
  wave.className = 'waveform';

  const map = {
    idle:       { icon:'üéô', s:'Press to speak',             h:'Tap to begin recording' },
    recording:  { icon:'‚èπ',  s:'Recording‚Ä¶',                 h:'Tap again to stop',          cls:'recording', wave:true },
    processing: { icon:'‚ü≥',  s:'Transcribing & analysing‚Ä¶',  h:'Please wait',                cls:'processing' },
    playing:    { icon:'üîä', s:'Playing response‚Ä¶',           h:'Audio playing',              cls:'playing' },
  };

  const s = map[state] || map.idle;
  icon.textContent   = s.icon;
  status.textContent = s.s;
  hint.textContent   = s.h;
  if (s.cls)  btn.classList.add(s.cls);
  if (s.wave) wave.classList.add('active');
}

function clearChat() {
  const container = document.getElementById('messages');
  container.innerHTML = `
    <div class="empty-state" id="emptyState">
      <div class="empty-icon">üìú</div>
      <div class="empty-title">Ask about Ghana's Constitution</div>
      <div class="empty-sub">Query any article, right, chapter or provision. Verdict AI cites the exact clause.</div>
      <div class="chips">
        <div class="chip" onclick="fill('What does Article 6 say?')">Article 6</div>
        <div class="chip" onclick="fill('What are the fundamental human rights?')">Human Rights</div>
        <div class="chip" onclick="fill('What does Article 35 say?')">Article 35</div>
        <div class="chip" onclick="fill('What is the role of Parliament?')">Parliament</div>
        <div class="chip" onclick="fill('What does the Constitution say about freedom of speech?')">Free Speech</div>
      </div>
    </div>`;
}

function clearVoiceChat() {
  document.getElementById('voiceMessages').innerHTML = '';
}

function stopAudio() {
  if (currentAudio) {
    currentAudio.pause();
    currentAudio.currentTime = 0;
    currentAudio = null;
  }
  if (isRecording) stopRecording();
  setOrb('idle');
  document.getElementById('stopAudioBtn').classList.remove('visible');
}


function hideEmpty() {
  const e = document.getElementById('emptyState');
  if (e) e.remove();
}

function addMsg(containerId, role, text) {
  const c = document.getElementById(containerId);
  const el = document.createElement('div');
  el.className = `message ${role}`;
  el.innerHTML = `
    <div class="msg-avatar">${role === 'user' ? 'YOU' : 'AI'}</div>
    <div class="msg-body">
      <div class="msg-label">${role === 'user' ? 'Your question' : 'Verdict AI'}</div>
      <div class="msg-text">${esc(text)}</div>
    </div>`;
  c.appendChild(el);
  el.scrollIntoView({ behavior: 'smooth', block: 'end' });
  return el;
}

function addThinking(containerId) {
  const c = document.getElementById(containerId);
  const el = document.createElement('div');
  el.className = 'thinking';
  el.innerHTML = `<div class="dot"></div><div class="dot"></div><div class="dot"></div><span>Consulting the Constitution‚Ä¶</span>`;
  c.appendChild(el);
  el.scrollIntoView({ behavior: 'smooth', block: 'end' });
  return el;
}

function esc(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br/>');
}
</script>
</body>
</html>