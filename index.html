<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Verdict AI ‚Äî Ghana Constitutional Law</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Serif:ital,wght@0,400;0,600;1,400&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg:           #f4f2ee;
    --surface:      #ffffff;
    --surface-2:    #eeece8;
    --border:       #d8d4cc;
    --border-light: #e8e4de;
    --text:         #1a1814;
    --text-2:       #5a5650;
    --text-3:       #9a9590;
    --accent:       #1a3a5c;
    --accent-2:     #2d5f8a;
    --gold:         #8a6f2e;
    --gold-light:   #c9a84c;
    --red:          #8b2020;
    --green:        #1a5c35;
    --shadow:       0 1px 3px rgba(0,0,0,0.08), 0 4px 16px rgba(0,0,0,0.04);
    --shadow-lg:    0 4px 24px rgba(0,0,0,0.10);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
  .topbar {
    background: var(--accent);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 32px;
    height: 56px;
    flex-shrink: 0;
  }

  .topbar-brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .topbar-seal {
    width: 30px;
    height: 30px;
    border: 1.5px solid rgba(255,255,255,0.35);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
  }

  .topbar-name {
    font-family: 'IBM Plex Serif', serif;
    font-size: 17px;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
  }

  .topbar-name span {
    font-weight: 400;
    font-style: italic;
    opacity: 0.75;
    font-size: 15px;
    margin-left: 4px;
  }

  .topbar-meta {
    font-size: 11px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    opacity: 0.5;
    font-family: 'IBM Plex Mono', monospace;
  }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  .layout {
    display: flex;
    flex: 1;
    max-width: 1100px;
    width: 100%;
    margin: 0 auto;
    padding: 32px 24px;
    gap: 24px;
  }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  .sidebar {
    width: 220px;
    flex-shrink: 0;
  }

  .sidebar-section {
    margin-bottom: 28px;
  }

  .sidebar-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-3);
    font-family: 'IBM Plex Mono', monospace;
    margin-bottom: 10px;
  }

  .mode-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 10px 12px;
    border: 1px solid transparent;
    border-radius: 4px;
    background: transparent;
    color: var(--text-2);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    text-align: left;
    margin-bottom: 2px;
  }

  .mode-btn:hover {
    background: var(--surface-2);
    color: var(--text);
  }

  .mode-btn.active {
    background: var(--surface);
    border-color: var(--border);
    color: var(--accent);
    box-shadow: var(--shadow);
  }

  .mode-btn .btn-icon {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    background: var(--surface-2);
    flex-shrink: 0;
  }

  .mode-btn.active .btn-icon {
    background: var(--accent);
    color: #fff;
  }

  .sidebar-divider {
    height: 1px;
    background: var(--border-light);
    margin: 20px 0;
  }

  .sidebar-info {
    font-size: 11px;
    color: var(--text-3);
    line-height: 1.7;
    font-family: 'IBM Plex Mono', monospace;
  }

  .status-dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
    margin-right: 6px;
    vertical-align: middle;
  }

  /* ‚îÄ‚îÄ Main panel ‚îÄ‚îÄ */
  .panel {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 600px;
  }

  .panel-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
  }

  .panel-title {
    font-family: 'IBM Plex Serif', serif;
    font-size: 20px;
    font-weight: 600;
    color: var(--text);
    line-height: 1.3;
  }

  .panel-title span {
    display: block;
    font-size: 12px;
    font-family: 'IBM Plex Mono', monospace;
    font-weight: 400;
    color: var(--text-3);
    margin-top: 3px;
    letter-spacing: 0.05em;
  }

  .panel-badge {
    font-size: 10px;
    font-family: 'IBM Plex Mono', monospace;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--gold);
    background: #f8f3e8;
    border: 1px solid #e8d8a8;
    padding: 4px 10px;
    border-radius: 3px;
    white-space: nowrap;
  }

  /* ‚îÄ‚îÄ Messages ‚îÄ‚îÄ */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .messages::-webkit-scrollbar { width: 4px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .message {
    display: flex;
    gap: 14px;
    padding: 16px 0;
    border-bottom: 1px solid var(--border-light);
    animation: fadeIn 0.25s ease;
  }

  .message:last-child { border-bottom: none; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .msg-avatar {
    width: 32px;
    height: 32px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    flex-shrink: 0;
    margin-top: 2px;
    font-family: 'IBM Plex Mono', monospace;
    font-weight: 500;
  }

  .message.user .msg-avatar {
    background: var(--accent);
    color: #fff;
    font-size: 11px;
  }

  .message.assistant .msg-avatar {
    background: #f0f4f8;
    border: 1px solid var(--border);
    color: var(--accent);
    font-size: 11px;
  }

  .msg-body { flex: 1; min-width: 0; }

  .msg-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-3);
    font-family: 'IBM Plex Mono', monospace;
    margin-bottom: 6px;
  }

  .message.user .msg-label { color: var(--accent-2); }

  .msg-text {
    font-size: 14px;
    line-height: 1.75;
    color: var(--text);
    font-weight: 300;
  }

  .message.assistant .msg-text {
    font-family: 'IBM Plex Serif', serif;
    font-size: 14.5px;
  }

  /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    text-align: center;
    color: var(--text-3);
  }

  .empty-icon {
    font-size: 36px;
    margin-bottom: 16px;
    opacity: 0.4;
  }

  .empty-title {
    font-family: 'IBM Plex Serif', serif;
    font-size: 18px;
    color: var(--text-2);
    margin-bottom: 8px;
    font-weight: 400;
  }

  .empty-sub {
    font-size: 13px;
    line-height: 1.6;
    max-width: 320px;
  }

  .suggestion-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 20px;
    justify-content: center;
  }

  .chip {
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: 3px;
    font-size: 12px;
    color: var(--text-2);
    cursor: pointer;
    transition: all 0.15s;
    background: var(--surface);
    font-family: 'IBM Plex Mono', monospace;
  }

  .chip:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: #f0f4f8;
  }

  /* ‚îÄ‚îÄ Input area ‚îÄ‚îÄ */
  .input-area {
    border-top: 1px solid var(--border-light);
    padding: 16px 24px;
    background: var(--surface);
  }

  .text-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }

  textarea {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 14px;
    font-weight: 300;
    padding: 12px 14px;
    resize: none;
    min-height: 46px;
    max-height: 160px;
    outline: none;
    transition: border-color 0.15s;
    line-height: 1.6;
  }

  textarea:focus { border-color: var(--accent); }
  textarea::placeholder { color: var(--text-3); }

  .send-btn {
    height: 46px;
    padding: 0 20px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 4px;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s;
    white-space: nowrap;
    letter-spacing: 0.02em;
  }

  .send-btn:hover { background: var(--accent-2); }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ‚îÄ‚îÄ Voice panel ‚îÄ‚îÄ */
  .voice-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 48px 24px;
    gap: 32px;
  }

  .voice-ring {
    position: relative;
    width: 120px;
    height: 120px;
  }

  .voice-btn {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    border: 1.5px solid var(--border);
    background: var(--surface);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    transition: all 0.2s;
    box-shadow: var(--shadow-lg);
  }

  .voice-btn:hover {
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(26,58,92,0.08), var(--shadow-lg);
  }

  .voice-btn.recording {
    border-color: var(--red);
    background: #fff8f8;
    animation: recordPulse 2s infinite;
  }

  .voice-btn.processing {
    border-color: var(--gold-light);
    background: #fffdf5;
  }

  .voice-btn.playing {
    border-color: var(--green);
    background: #f5fdf8;
  }

  @keyframes recordPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(139,32,32,0.15), var(--shadow-lg); }
    50%       { box-shadow: 0 0 0 12px rgba(139,32,32,0), var(--shadow-lg); }
  }

  .voice-indicator {
    text-align: center;
  }

  .voice-status-text {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-2);
    letter-spacing: 0.03em;
    margin-bottom: 4px;
  }

  .voice-hint {
    font-size: 11px;
    color: var(--text-3);
    font-family: 'IBM Plex Mono', monospace;
  }

  /* Waveform */
  .waveform {
    display: flex;
    align-items: center;
    gap: 3px;
    height: 24px;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .waveform.active { opacity: 1; }

  .bar {
    width: 2px;
    background: var(--red);
    border-radius: 1px;
    animation: wavebar 0.9s ease-in-out infinite;
  }

  .bar:nth-child(1) { animation-delay: 0.0s; }
  .bar:nth-child(2) { animation-delay: 0.1s; }
  .bar:nth-child(3) { animation-delay: 0.2s; }
  .bar:nth-child(4) { animation-delay: 0.3s; }
  .bar:nth-child(5) { animation-delay: 0.4s; }
  .bar:nth-child(6) { animation-delay: 0.3s; }
  .bar:nth-child(7) { animation-delay: 0.2s; }
  .bar:nth-child(8) { animation-delay: 0.1s; }
  .bar:nth-child(9) { animation-delay: 0.0s; }

  @keyframes wavebar {
    0%, 100% { height: 3px; }
    50%       { height: 18px; }
  }

  /* ‚îÄ‚îÄ Thinking ‚îÄ‚îÄ */
  .thinking {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 16px 0;
    color: var(--text-3);
    font-size: 12px;
    font-family: 'IBM Plex Mono', monospace;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--border-light);
  }

  .dot {
    width: 3px;
    height: 3px;
    background: var(--gold-light);
    border-radius: 50%;
    animation: blink 1.2s infinite;
  }
  .dot:nth-child(2) { animation-delay: 0.2s; }
  .dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes blink {
    0%, 100% { opacity: 0.2; transform: scale(1); }
    50%       { opacity: 1;   transform: scale(1.4); }
  }

  /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
  .error-msg {
    padding: 10px 14px;
    background: #fdf5f5;
    border: 1px solid #e8c0c0;
    border-radius: 4px;
    font-size: 13px;
    color: var(--red);
    margin-top: 8px;
    font-family: 'IBM Plex Mono', monospace;
  }

  /* ‚îÄ‚îÄ Utility ‚îÄ‚îÄ */
  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- Top bar -->
<div class="topbar">
  <div class="topbar-brand">
    <div class="topbar-seal">‚öñ</div>
    <div class="topbar-name">Verdict<span>AI</span></div>
  </div>
  <div class="topbar-meta">Ghana Constitutional Law ¬∑ Research Assistant</div>
</div>

<!-- Layout -->
<div class="layout">

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Interface</div>
      <button class="mode-btn active" id="textModeBtn" onclick="setMode('text')">
        <div class="btn-icon">‚å®</div>
        Text Query
      </button>
      <button class="mode-btn" id="voiceModeBtn" onclick="setMode('voice')">
        <div class="btn-icon">üéô</div>
        Voice Query
      </button>
    </div>

    <div class="sidebar-divider"></div>

    <div class="sidebar-section">
      <div class="sidebar-label">System</div>
      <div class="sidebar-info">
        <div><span class="status-dot"></span>RAG Online</div>
        <div style="margin-top:6px;">Model: LLaMA 3.3 70B</div>
        <div style="margin-top:4px;">STT: Whisper v3</div>
        <div style="margin-top:4px;">TTS: ElevenLabs</div>
        <div style="margin-top:4px;">Source: GH Constitution</div>
      </div>
    </div>

    <div class="sidebar-divider"></div>

    <div class="sidebar-section">
      <div class="sidebar-label">Built by</div>
      <div class="sidebar-info">Lucas ¬∑ 2025</div>
    </div>
  </div>

  <!-- Panel -->
  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">
        Constitutional Query
        <span id="modeLabel">Text mode ¬∑ Ask any question</span>
      </div>
      <div class="panel-badge">1992 Constitution</div>
    </div>

    <!-- TEXT MODE -->
    <div id="textMode">
      <div class="messages" id="messages">
        <div class="empty-state" id="emptyState">
          <div class="empty-icon">üìú</div>
          <div class="empty-title">Ask about Ghana's Constitution</div>
          <div class="empty-sub">Query any article, right, chapter, or provision. Verdict AI will find and cite the exact clause.</div>
          <div class="suggestion-chips">
            <div class="chip" onclick="fillQuestion('What does Article 6 say?')">Article 6</div>
            <div class="chip" onclick="fillQuestion('What are the fundamental human rights?')">Human Rights</div>
            <div class="chip" onclick="fillQuestion('What does Article 35 say about the state?')">Article 35</div>
            <div class="chip" onclick="fillQuestion('What is the role of Parliament?')">Parliament</div>
          </div>
        </div>
      </div>

      <div class="input-area">
        <div class="text-row">
          <textarea
            id="questionInput"
            placeholder="Ask about any article, right, or provision‚Ä¶"
            rows="1"
            onkeydown="handleKey(event)"
            oninput="autoResize(this)"
          ></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendText()">Submit</button>
        </div>
        <div id="textError"></div>
      </div>
    </div>

    <!-- VOICE MODE -->
    <div id="voiceMode" class="hidden">
      <div class="messages" id="voiceMessages"></div>

      <div class="input-area">
        <div class="voice-panel">
          <div class="waveform" id="waveform">
            <div class="bar"></div><div class="bar"></div><div class="bar"></div>
            <div class="bar"></div><div class="bar"></div><div class="bar"></div>
            <div class="bar"></div><div class="bar"></div><div class="bar"></div>
          </div>

          <div class="voice-ring">
            <div class="voice-btn" id="voiceBtn" onclick="toggleRecording()">
              <span id="orbIcon">üéô</span>
            </div>
          </div>

          <div class="voice-indicator">
            <div class="voice-status-text" id="voiceStatus">Press to speak</div>
            <div class="voice-hint" id="voiceHint">Hold to record ¬∑ Release or tap to stop</div>
          </div>
        </div>
        <div id="voiceError"></div>
      </div>
    </div>

  </div>
</div>

<script>
const API = 'http://localhost:8000';
let mode = 'text';
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let currentAudio = null;

// ‚îÄ‚îÄ Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setMode(m) {
  mode = m;
  document.getElementById('textMode').classList.toggle('hidden', m !== 'text');
  document.getElementById('voiceMode').classList.toggle('hidden', m !== 'voice');
  document.getElementById('textModeBtn').classList.toggle('active', m === 'text');
  document.getElementById('voiceModeBtn').classList.toggle('active', m === 'voice');
  document.getElementById('modeLabel').textContent =
    m === 'text' ? 'Text mode ¬∑ Ask any question' : 'Voice mode ¬∑ Speak your question';
}

// ‚îÄ‚îÄ Text ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendText(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 160) + 'px';
}

function fillQuestion(q) {
  const input = document.getElementById('questionInput');
  input.value = q;
  input.focus();
  autoResize(input);
}

async function sendText() {
  const input = document.getElementById('questionInput');
  const question = input.value.trim();
  if (!question) return;

  input.value = '';
  input.style.height = 'auto';
  document.getElementById('sendBtn').disabled = true;
  document.getElementById('textError').innerHTML = '';

  hideEmpty();
  addMessage('text', 'user', question);
  const thinking = addThinking('text');

  try {
    const res = await fetch(`${API}/ask`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question })
    });
    if (!res.ok) throw new Error('Server error');
    const data = await res.json();
    thinking.remove();
    addMessage('text', 'assistant', data.answer);
  } catch (e) {
    thinking.remove();
    document.getElementById('textError').innerHTML =
      `<div class="error-msg">‚ö† Could not reach Verdict AI. Is the server running?</div>`;
  }

  document.getElementById('sendBtn').disabled = false;
}

// ‚îÄ‚îÄ Voice ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function toggleRecording() {
  if (isRecording) stopRecording();
  else await startRecording();
}

async function startRecording() {
  if (currentAudio) { currentAudio.pause(); currentAudio = null; }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioChunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = processVoice;
    mediaRecorder.start();
    isRecording = true;
    setOrbState('recording');
  } catch {
    document.getElementById('voiceError').innerHTML =
      `<div class="error-msg">‚ö† Microphone access denied. Please allow mic permissions.</div>`;
  }
}

function stopRecording() {
  if (mediaRecorder && isRecording) {
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(t => t.stop());
    isRecording = false;
    setOrbState('processing');
  }
}

async function processVoice() {
  const blob = new Blob(audioChunks, { type: 'audio/webm' });
  const formData = new FormData();
  formData.append('audio', blob, 'recording.webm');
  document.getElementById('voiceError').innerHTML = '';

  try {
    const res = await fetch(`${API}/ask-voice`, { method: 'POST', body: formData });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || 'Voice request failed');
    }

    const qRaw = res.headers.get('X-Question') || '';
    const aRaw = res.headers.get('X-Answer') || '';
    const question = qRaw ? atob(qRaw) : '(voice question)';
    const answerPreview = aRaw ? atob(aRaw) : '';

    addMessage('voice', 'user', question);
    addMessage('voice', 'assistant', answerPreview + (answerPreview.length >= 800 ? '‚Ä¶' : ''));

    const audioBlob = await res.blob();
    const audioUrl = URL.createObjectURL(audioBlob);
    currentAudio = new Audio(audioUrl);
    setOrbState('playing');
    currentAudio.play();
    currentAudio.onended = () => { setOrbState('idle'); URL.revokeObjectURL(audioUrl); };

  } catch (e) {
    setOrbState('idle');
    document.getElementById('voiceError').innerHTML =
      `<div class="error-msg">‚ö† ${e.message || 'Voice processing failed'}</div>`;
  }
}

function setOrbState(state) {
  const btn    = document.getElementById('voiceBtn');
  const status = document.getElementById('voiceStatus');
  const hint   = document.getElementById('voiceHint');
  const wave   = document.getElementById('waveform');
  const icon   = document.getElementById('orbIcon');

  btn.className = 'voice-btn';
  wave.className = 'waveform';

  const map = {
    idle:       { icon: 'üéô', status: 'Press to speak',            hint: 'Tap to begin recording' },
    recording:  { icon: '‚èπ',  status: 'Recording‚Ä¶',               hint: 'Tap again to stop', cls: 'recording', wave: true },
    processing: { icon: '‚ü≥',  status: 'Transcribing & analysing‚Ä¶', hint: 'Please wait',       cls: 'processing' },
    playing:    { icon: 'üîä', status: 'Playing response‚Ä¶',         hint: 'Audio playing',     cls: 'playing' },
  };

  const s = map[state] || map.idle;
  icon.textContent  = s.icon;
  status.textContent = s.status;
  hint.textContent   = s.hint;
  if (s.cls)  btn.classList.add(s.cls);
  if (s.wave) wave.classList.add('active');
}

// ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function hideEmpty() {
  const e = document.getElementById('emptyState');
  if (e) e.remove();
}

function addMessage(panel, role, text) {
  const container = panel === 'text'
    ? document.getElementById('messages')
    : document.getElementById('voiceMessages');

  const el = document.createElement('div');
  el.className = `message ${role}`;
  el.innerHTML = `
    <div class="msg-avatar">${role === 'user' ? 'YOU' : 'AI'}</div>
    <div class="msg-body">
      <div class="msg-label">${role === 'user' ? 'Your question' : 'Verdict AI'}</div>
      <div class="msg-text">${escHtml(text)}</div>
    </div>`;
  container.appendChild(el);
  el.scrollIntoView({ behavior: 'smooth', block: 'end' });
  return el;
}

function addThinking(panel) {
  const container = panel === 'text'
    ? document.getElementById('messages')
    : document.getElementById('voiceMessages');

  const el = document.createElement('div');
  el.className = 'thinking';
  el.innerHTML = `<div class="dot"></div><div class="dot"></div><div class="dot"></div><span>Consulting the Constitution</span>`;
  container.appendChild(el);
  el.scrollIntoView({ behavior: 'smooth', block: 'end' });
  return el;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br/>');
}
</script>
</body>
</html>